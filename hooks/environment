#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=hooks/lib/common.sh
source "${SCRIPT_DIR}/lib/common.sh"

: "${BUILDKITE_PLUGIN_GIT_ENABLED:=true}"
: "${BUILDKITE_PLUGIN_GIT_DEBUG:=false}"
: "${BUILDKITE_PLUGIN_GIT_EXECUTE_PHASE:=post-command}"
: "${BUILDKITE_PLUGIN_GIT_SKIP_ON_COMMAND_FAILURE:=true}"
: "${BUILDKITE_PLUGIN_GIT_CLEANUP:=true}"

: "${BUILDKITE_PLUGIN_GIT_AUTH_MODE:=ssh}"
: "${BUILDKITE_PLUGIN_GIT_AUTH_TOKEN_ENV:=GITHUB_TOKEN}"
: "${BUILDKITE_PLUGIN_GIT_AUTH_TOKEN_USER:=x-access-token}"

: "${BUILDKITE_PLUGIN_GIT_BASE_BRANCH:=main}"

: "${BUILDKITE_PLUGIN_GIT_PR_ENABLED:=true}"
: "${BUILDKITE_PLUGIN_GIT_PR_UPDATE_EXISTING:=true}"
: "${BUILDKITE_PLUGIN_GIT_PR_CLOSE_DRAFTS:=false}"
: "${BUILDKITE_PLUGIN_GIT_PR_SKIP_IF_DRAFT_EXISTS:=false}"

: "${BUILDKITE_PLUGIN_GIT_SLACK_ENABLED:=false}"
: "${BUILDKITE_PLUGIN_GIT_SLACK_NOTIFY_ON_NO_CHANGES:=false}"
: "${BUILDKITE_PLUGIN_GIT_SLACK_FAIL_ON_ERROR:=false}"

: "${BUILDKITE_PLUGIN_GIT_FAIL_ON_NO_CHANGES:=false}"
: "${BUILDKITE_PLUGIN_GIT_COMMIT_SIGNOFF:=false}"
: "${BUILDKITE_PLUGIN_GIT_COMMIT_GPG_SIGN:=false}"
: "${BUILDKITE_PLUGIN_GIT_PUSH_FORCE_WITH_LEASE:=false}"

export BUILDKITE_PLUGIN_GIT_ENABLED
export BUILDKITE_PLUGIN_GIT_DEBUG
export BUILDKITE_PLUGIN_GIT_EXECUTE_PHASE
export BUILDKITE_PLUGIN_GIT_SKIP_ON_COMMAND_FAILURE
export BUILDKITE_PLUGIN_GIT_CLEANUP
export BUILDKITE_PLUGIN_GIT_AUTH_MODE
export BUILDKITE_PLUGIN_GIT_AUTH_TOKEN_ENV
export BUILDKITE_PLUGIN_GIT_AUTH_TOKEN_USER
export BUILDKITE_PLUGIN_GIT_BASE_BRANCH
export BUILDKITE_PLUGIN_GIT_PR_ENABLED
export BUILDKITE_PLUGIN_GIT_PR_UPDATE_EXISTING
export BUILDKITE_PLUGIN_GIT_PR_CLOSE_DRAFTS
export BUILDKITE_PLUGIN_GIT_PR_SKIP_IF_DRAFT_EXISTS
export BUILDKITE_PLUGIN_GIT_SLACK_ENABLED
export BUILDKITE_PLUGIN_GIT_SLACK_NOTIFY_ON_NO_CHANGES
export BUILDKITE_PLUGIN_GIT_SLACK_FAIL_ON_ERROR
export BUILDKITE_PLUGIN_GIT_FAIL_ON_NO_CHANGES
export BUILDKITE_PLUGIN_GIT_COMMIT_SIGNOFF
export BUILDKITE_PLUGIN_GIT_COMMIT_GPG_SIGN
export BUILDKITE_PLUGIN_GIT_PUSH_FORCE_WITH_LEASE

if [[ "${BUILDKITE_PLUGIN_GIT_DEBUG}" == "true" ]]; then
  set -x
fi

# Install dependencies and export PATH so all subsequent hook phases have access.
# Each ensure_* call is a no-op when the tool is already present.
if is_true "${BUILDKITE_PLUGIN_GIT_ENABLED}"; then
  if sync_uses_merge_yaml; then
    ensure_yq_installed
  fi

  if is_true "${BUILDKITE_PLUGIN_GIT_PR_ENABLED}"; then
    ensure_gh_installed
  fi

  export PATH
fi

echo "--- [git-automation] Environment defaults loaded"
